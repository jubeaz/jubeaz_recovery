---

- name: assert proper distribution
  assert:
    that:
      - ansible_distribution in ['Kali', 'Ubuntu', 'Archlinux']
    quiet: true

- include_tasks: "{{ ansible_distribution }}.yml" 

- name: Enable ipv4 forward
  ansible.builtin.lineinfile:
    path: /etc/ufw/sysctl.conf
    regexp: '^#net/ipv4/ip_forward=1'
    line:  'net/ipv4/ip_forward=1'
  when: ufw_forward

- name: Enable ipv6 default forward
  ansible.builtin.lineinfile:
    path: /etc/ufw/sysctl.conf
    regexp: '^#net/ipv6/conf/default/forwarding=1'
    line:  'net/ipv6/conf/default/forwarding=1'
  when: ufw_forward

- name: Enable ipv6 all forward
  ansible.builtin.lineinfile:
    path: /etc/ufw/sysctl.conf
    regexp: '^#net/ipv6/conf/all/forwarding=1'
    line:  'net/ipv6/conf/all/forwarding=1'
  when: ufw_forward

- name: define default forward policy
  ansible.builtin.lineinfile:
    path: /etc/default/ufw
    regexp: '^DEFAULT_FORWARD_POLICY="DROP"'
    line:  'DEFAULT_FORWARD_POLICY="ACCEPT"'
  when: ufw_forward


- name: reboot
  ansible.builtin.reboot:

- name: ufw add ssh in rule
  ufw:
    rule: allow
    direction: in
    src: "{{ item }}"
    to_port: 22
  loop: "{{ ufw_in_ssh_ip }}"
  notify: 
    - enable ufw service
    - enable ufw

#/etc/ufw/before.rules:
## ADD BEFORE FILTER

## NAT table rules
#*nat
#:POSTROUTING ACCEPT [0:0]
#
## Forward traffic through eth0 - Change to match you out-interface
#-A POSTROUTING -s 172.16.0.0/16 -o eth1 -j MASQUERADE
#
## don't delete the 'COMMIT' line or these nat table rules won't
## be processed
#COMMIT

